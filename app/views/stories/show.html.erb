<%# Show story %>
<div class="cf">
  <div class="fl w-100 ph3 black-80 lh-copy fs-11pt mt3">
    <h4 class="ma0 lh-copy">
      <%# Upvote button %>
      <% if @user %>
        <%# TODO (pyk): Update this to link_to %>
        <a href="#"
          class="link black-50 tc mr1">
          <svg width="10" height="12" viewBox="0 0 14 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-top: 3px;">
          <path d="M7 0L13.9282 12H0.0717969L7 0Z" fill="rgba(0,0,0,0.3)" />
          </svg>
        </a>
      <% else %>
        <%# TODO (pyk): Update this to link_to %>
        <a href="/login"
          class="link black-50 tc mr1">
          <svg width="10" height="12" viewBox="0 0 14 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-top: 3px;">
          <path d="M7 0L13.9282 12H0.0717969L7 0Z" fill="rgba(0,0,0,0.3)" />
          </svg>
        </a>
      <% end %>

      <%# Story title %>
      <a href="<%= @story.url_or_comments_path %>"
      class="link underline-hover black-80 mr1">
      <%= break_long_words(@story.title) %>
      </a>

      <%# Show description icon, if description is present %>
      <% if @story.markeddown_description.present? %>
        <a class="link gray mr1"
        title="<%= truncate(@story.description, :length => 250) %>"
        href="<%= @story.comments_path %>"><i class="fas fa-align-left"></i></a>
      <% end %>

      <%# Show tags %>
      <span>
        <% @story.tags.each do |tag| %>
          <a href="<%= tag_path(tag) %>"
          class="<%= tag.css_class %> tag mr1 gray"
          title="<%= tag.description %>"
          style="background-color: <%= tag.background_color %>; color: <%= tag.text_color %>;"><%= tag.tag %></a>
        <% end %>
      </span>

      <%# Show domain if any %>
      <% if @story.domain.present? %>
      <a class="link gray underline-hover normal"
      href="<%= @story.domain_search_url %>" >
      <%= break_long_words(@story.domain) %>
      </a>
      <% end %>
    </h4>

    <%# Display meta data %>
    <p class="ma0 gray mt1 lh-copy">
      <%# Display current points %>
      <% if @story.score >= 2 %>
        <%= @story.score %> points
      <% else %>
        <%= @story.score %> point
      <% end %>

      <%# Display 'authored by' or 'via' %>
      <% if @story.user_is_author? %>
        authored by
      <% else %>
        via
      <% end %>

      <%# User avatar and username%>
      <% if (@user && @user.show_avatars?) || !@user %>
        <a href="/u/<%= @story.user.username %>"><%= avatar_img(@story.user, 16) %></a>
      <% end %>
      <a href="/u/<%= @story.user.username %>"
        class="<%= @story.html_class_for_user %> gray underline-hover link">
        <%= @story.user.username %>
      </a>

      <%# Time story submitted %>
      <%= time_ago_in_words_label(@story.created_at) %>

      <%# Show link to cache url, if story url is present %>
      <% if @story.url.present? %>
      | <a href="<%= @story.archive_url %>"
          rel="nofollow"
          target="_blank"
          class="gray underline-hover link">cached</a>
      <% end %>

      <%# Show link to edit story, if story is editable by current user %>
      <% if @story.is_editable_by_user?(@user) %>
      | <a href="<%= edit_story_path(@story.short_id)%>"
        class="gray underline-hover link">edit</a>
      <% end %>

      <%# Show link to comments %>
      | <span class="gray ">
        <% if @story.comments_count == 0 %>
        no comments
        <% else %>
        <%= @story.comments_count %>
        comment<%= @story.comments_count == 1 ? "" : "s" %>
        <% end %>
      </span>
    </p>

    <%# Display story text if any %>
    <% if @story.markeddown_description.present? %>
      <%= raw @story.markeddown_description %>
    <% end %>
  </div>
</div>

<%# Comments %>
<div class="cf">
  <div class="fl w-100 ph3">
    <%# Display comment box %>
    <% if @user %>
      <%= form_for @comment,
        :html => {:class => "mt3 mb5 measure"} do |f| %>
        <%# Show errors if posted comment is invalid %>
        <% if @comment.errors.any? %>
          <%= errors_for @comment %>
        <% end %>

        <%# Hidden fields for controller %>
        <%= f.hidden_field :story_id,
          :value => @comment.story.short_id %>

        <%# Display text area for comment %>
        <%= f.text_area :comment,
          :class => "input-reset ba b--black-20 pa2 mb2 db w-100",
          :rows => 5 %>
        <small id="name-desc" class="fr f7 black-60 db mb2">
        Markdown are supported
        </small>
        <%= f.submit "Add comment",
          :class => "pv1 ph2 mr3" %>
      <% end %>
    <% else %>
      <%# Disable the form if user is not logged in %>
      <%= form_for @comment, :html => {:class => "mt3 measure"} do |f| %>
        <%# Display text area for comment %>
        <%= f.text_area :comment,
          :class => "input-reset ba b--black-20 pa2 mb2 db w-100",
          :rows => 5,
          :disabled => true,
          :placeholder => "You must be logged in to leave a comment." %>
        <small id="name-desc" class="fr f7 black-60 db mb2">
        Markdown are supported
        </small>
        <%= f.submit "Add comment",
          :disabled => true,
          :class => "pv1 ph2 mr3" %>
      <% end %>
    <% end %>

    <%# Display comments %>
    <ol class="list pl0">
      <% replies_data = @comments.group_by(&:parent_comment_id)%>
      <% root_comments = replies_data[nil] %>
      <%= render partial: "comment",
        collection: root_comments,
        as: :comment,
        locals: {replies_data: replies_data} %>
    </ol>
  </div>
</div>
